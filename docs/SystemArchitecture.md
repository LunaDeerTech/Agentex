# Agentex 系统架构设计

## 文档信息

| 项目 | 内容 |
|------|------|
| 产品名称 | Agentex |
| 版本 | 1.0.0 |
| 文档版本 | 1.0 |
| 更新日期 | 2026-02-03 |

---

## 1. 架构概述

### 1.1 系统架构图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                   用户层                                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │   浏览器     │  │   浏览器     │  │   浏览器     │  │    ...      │             │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘             │
└─────────┼────────────────┼────────────────┼────────────────┼────────────────────┘
          │                │                │                │
          └────────────────┴────────────────┴────────────────┘
                                    │
                            HTTPS / WSS
                                    │
┌───────────────────────────────────┼─────────────────────────────────────────────┐
│                                   │           网关层                             │
│                           ┌───────┴───────┐                                     │
│                           │  Nginx/Caddy  │                                     │
│                           │  反向代理      │                                     │
│                           └───────┬───────┘                                     │
└───────────────────────────────────┼─────────────────────────────────────────────┘
                                    │
          ┌─────────────────────────┼─────────────────────────┐
          │                         │                         │
┌─────────┼─────────────────────────┼─────────────────────────┼───────────────────┐
│         ▼                         ▼                         ▼     前端层        │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         Vue 3 SPA 应用                                   │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │   │
│  │  │  Agent   │  │  设置    │  │  SKILL   │  │  规则    │  │  知识库  │   │   │
│  │  │  对话    │  │  页面    │  │  管理    │  │  配置    │  │  管理    │   │   │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │   │
│  │                                                                          │   │
│  │  ┌──────────────────────────────────────────────────────────────────┐   │   │
│  │  │  Pinia Store │ Vue Router │ Axios │ AG-UI Client              │   │   │
│  │  └──────────────────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────┘
                                    │
                           HTTP REST / AG-UI (SSE)
                                    │
┌───────────────────────────────────┼─────────────────────────────────────────────┐
│                                   ▼                后端层                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         FastAPI 应用服务                                 │   │
│  │                                                                          │   │
│  │  ┌────────────┬────────────┬────────────┬────────────┬────────────┐     │   │
│  │  │  API 路由  │   AG-UI   │  中间件    │  依赖注入  │  异常处理  │     │   │
│  │  │  Router    │  Handler   │ Middleware │ Dependency │  Handler   │     │   │
│  │  └────────────┴────────────┴────────────┴────────────┴────────────┘     │   │
│  │                                                                          │   │
│  │  ┌─────────────────────────── 业务服务层 ───────────────────────────┐   │   │
│  │  │                                                                    │   │   │
│  │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐          │   │   │
│  │  │  │ 用户服务 │  │ 会话服务 │  │ Agent    │  │ 模型服务 │          │   │   │
│  │  │  │ UserSvc  │  │ ChatSvc  │  │ Service  │  │ ModelSvc │          │   │   │
│  │  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘          │   │   │
│  │  │                                                                    │   │   │
│  │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐          │   │   │
│  │  │  │ MCP服务  │  │ SKILL    │  │ RAG服务  │  │ 规则引擎 │          │   │   │
│  │  │  │ MCPSvc   │  │ Service  │  │ RAGSvc   │  │ RuleSvc  │          │   │   │
│  │  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘          │   │   │
│  │  │                                                                    │   │   │
│  │  └────────────────────────────────────────────────────────────────────┘   │   │
│  │                                                                          │   │
│  │  ┌─────────────────────────── Agent 架构层 ─────────────────────────┐   │   │
│  │  │                                                                    │   │   │
│  │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐          │   │   │
│  │  │  │  ReAct   │  │ Agentic  │  │ Plan &   │  │Reflexion │          │   │   │
│  │  │  │  Agent   │  │ RAG      │  │ Execute  │  │  Agent   │          │   │   │
│  │  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘          │   │   │
│  │  │                         ▲                                          │   │   │
│  │  │                         │                                          │   │   │
│  │  │              ┌──────────┴──────────┐                              │   │   │
│  │  │              │    BaseAgent 基类    │                              │   │   │
│  │  │              └─────────────────────┘                              │   │   │
│  │  │                                                                    │   │   │
│  │  └────────────────────────────────────────────────────────────────────┘   │   │
│  │                                                                          │   │
│  │  ┌─────────────────────────── 集成层 ───────────────────────────────┐   │   │
│  │  │                                                                    │   │   │
│  │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐          │   │   │
│  │  │  │ OpenAI   │  │Anthropic │  │ MCP      │  │ WS-MCP   │          │   │   │
│  │  │  │ Client   │  │ Client   │  │ Client   │  │ Client   │          │   │   │
│  │  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘          │   │   │
│  │  │                                                                    │   │   │
│  │  └────────────────────────────────────────────────────────────────────┘   │   │
│  │                                                                          │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────┘
          │              │              │              │              │
          ▼              ▼              ▼              ▼              ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                   数据层                                         │
│                                                                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐        │
│  │  PostgreSQL  │  │    Redis     │  │ Milvus/Qdrant│  │ File Storage │        │
│  │  主数据库     │  │  缓存/队列   │  │  向量数据库   │  │  文件存储    │        │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘        │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
          │                                              │
          ▼                                              ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                  外部服务层                                      │
│                                                                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐        │
│  │   OpenAI     │  │  Anthropic   │  │ MCP Server   │  │ WS-MCP Server│        │
│  │   API        │  │   API        │  │  (标准)      │  │  (自定义)    │        │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘        │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 架构设计原则

| 原则 | 说明 |
|------|------|
| 分层架构 | 清晰的层次划分，各层职责明确 |
| 松耦合 | 模块间通过接口通信，降低耦合度 |
| 高内聚 | 相关功能聚合在同一模块内 |
| 可扩展 | 预留扩展点，便于添加新功能 |
| 可测试 | 依赖注入，便于单元测试 |

---

## 2. 技术架构

### 2.1 技术栈选型

#### 2.1.1 后端技术栈

| 层次 | 技术 | 版本 | 说明 |
|------|------|------|------|
| Web 框架 | FastAPI | 0.110+ | 高性能异步框架，自动 OpenAPI 文档 |
| ASGI 服务器 | Uvicorn | 0.27+ | 高性能 ASGI 服务器 |
| ORM | SQLAlchemy | 2.0+ | 异步 ORM 支持 |
| 数据验证 | Pydantic | 2.0+ | 数据模型验证 |
| 异步 HTTP | httpx | 0.27+ | 异步 HTTP 客户端 |
| WebSocket | websockets | 12.0+ | WS-MCP 连接库 |
| AG-UI | ag-ui-protocol | 1.0+ | Agent-User 交互协议 SDK |
| 任务队列 | Celery | 5.3+ | 异步任务处理 |
| 消息代理 | Redis | 7.0+ | 任务队列后端 |
| 向量操作 | numpy | 1.26+ | 数值计算 |
| 文档解析 | unstructured | 0.12+ | 多格式文档解析 |
| JWT | python-jose | 3.3+ | JWT 认证 |
| 密码哈希 | passlib | 1.7+ | 密码安全存储 |

#### 2.1.2 前端技术栈

| 层次 | 技术 | 版本 | 说明 |
|------|------|------|------|
| 框架 | Vue | 3.4+ | 渐进式前端框架 |
| 构建工具 | Vite | 5.0+ | 快速构建工具 |
| 语言 | TypeScript | 5.3+ | 类型安全 |
| 状态管理 | Pinia | 2.1+ | Vue 3 官方状态管理 |
| 路由 | Vue Router | 4.2+ | 官方路由库 |
| UI 组件 | Element Plus | 2.5+ | Vue 3 UI 组件库 |
| HTTP 客户端 | Axios | 1.6+ | HTTP 请求库 |
| AG-UI | EventSource + Fetch | - | SSE 流式响应（原生支持） |
| Markdown | markdown-it | 14.0+ | Markdown 解析渲染 |
| 代码高亮 | highlight.js | 11.9+ | 代码语法高亮 |
| 图标 | @iconify/vue | 4.1+ | 图标库 |
| 拖拽 | vue-draggable-plus | 0.3+ | 拖拽组件 |
| 图表 | ECharts | 5.4+ | 可视化图表 |

#### 2.1.3 数据存储

| 类型 | 技术 | 版本 | 用途 |
|------|------|------|------|
| 关系数据库 | PostgreSQL | 15+ | 主数据存储 |
| 缓存 | Redis | 7.0+ | 会话缓存、消息队列 |
| 向量数据库 | Milvus | 2.3+ | RAG 向量存储（主选） |
| 向量数据库 | Qdrant | 1.7+ | RAG 向量存储（备选） |
| 文件存储 | MinIO | - | 文档文件存储（可选） |
| 文件存储 | 本地文件系统 | - | 开发环境文件存储 |

#### 2.1.4 基础设施

| 类型 | 技术 | 说明 |
|------|------|------|
| 容器 | Docker | 容器化部署 |
| 编排 | Docker Compose | 开发环境编排 |
| 反向代理 | Nginx / Caddy | 负载均衡、SSL 终止 |
| 日志 | Loguru | 结构化日志 |
| 监控 | Prometheus + Grafana | 性能监控（可选） |

### 2.2 通信架构

#### 2.2.1 通信协议

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              通信协议架构                                        │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│   前端 ←─────────────────────────────────────────────────────────→ 后端         │
│                                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                         HTTP REST API                                    │   │
│   │                                                                          │   │
│   │  用途：常规 CRUD 操作、配置管理、认证授权                                  │   │
│   │  格式：JSON                                                              │   │
│   │  认证：Bearer Token (JWT)                                                │   │
│   │                                                                          │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                     AG-UI (Agent-User Interaction Protocol)              │   │
│   │                                                                          │   │
│   │  用途：Agent 对话、实时消息流式推送、状态同步                               │   │
│   │  传输：HTTP SSE（服务端事件流）                                            │   │
│   │  格式：事件驱动的 JSON 流                                                 │   │
│   │  认证：请求头 Bearer Token (JWT)                                          │   │
│   │                                                                          │   │
│   │  事件类型：                                                               │   │
│   │  - RUN_STARTED / RUN_FINISHED / RUN_ERROR：生命周期事件                    │   │
│   │  - TEXT_MESSAGE_START / CONTENT / END：文本消息流                         │   │
│   │  - TOOL_CALL_START / ARGS / END / RESULT：工具调用                        │   │
│   │  - STEP_STARTED / STEP_FINISHED：步骤（思考过程）                          │   │
│   │  - STATE_SNAPSHOT / STATE_DELTA：状态管理                                 │   │
│   │                                                                          │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│   后端 ←─────────────────────────────────────────────────────────→ 外部服务     │
│                                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                         HTTP (LLM API)                                   │   │
│   │                                                                          │   │
│   │  用途：调用 OpenAI/Anthropic 等 LLM 服务                                  │   │
│   │  支持：流式响应 (SSE)                                                     │   │
│   │                                                                          │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                     HTTP SSE (标准 MCP)                                  │   │
│   │                                                                          │   │
│   │  用途：连接标准 MCP Server                                                │   │
│   │  协议：JSON-RPC 2.0 over SSE                                             │   │
│   │                                                                          │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                      WebSocket (WS-MCP)                                  │   │
│   │                                                                          │   │
│   │  用途：连接自定义 WS-MCP Server                                           │   │
│   │  协议：JSON-RPC 2.0 over WebSocket（带认证和事件）                         │   │
│   │  详见：CustomizeWsMessageProcotol.md                                     │   │
│   │                                                                          │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

#### 2.2.2 AG-UI 协议通信格式

AG-UI（Agent-User Interaction Protocol）是一个开放的、事件驱动的协议，用于标准化 AI Agent 与用户前端应用之间的通信。

**请求格式（RunAgentInput）：**

客户端通过 HTTP POST 请求发送到 `/api/v1/agent/run`，返回 SSE 事件流。

```json
{
  "thread_id": "session-uuid",
  "run_id": "run-uuid",
  "state": {},
  "messages": [
    {
      "id": "msg-uuid",
      "role": "user",
      "content": "用户消息内容"
    }
  ],
  "tools": [
    {
      "name": "world_tps_get",
      "description": "获取服务器 TPS",
      "parameters": {}
    }
  ],
  "context": [],
  "forwarded_props": {
    "agent_type": "react",
    "model_id": "model-uuid",
    "knowledge_base_ids": ["kb-uuid-1"],
    "mcp_connection_ids": ["mcp-uuid-1"],
    "skill_ids": ["skill-uuid-1"]
  }
}
```

**响应格式（SSE 事件流）：**

服务端通过 Server-Sent Events 流式返回 AG-UI 标准事件。

```
event: RUN_STARTED
data: {"type":"RUN_STARTED","thread_id":"session-uuid","run_id":"run-uuid"}

event: STEP_STARTED
data: {"type":"STEP_STARTED","step_name":"thinking"}

event: TEXT_MESSAGE_START
data: {"type":"TEXT_MESSAGE_START","message_id":"msg-uuid","role":"assistant"}

event: TEXT_MESSAGE_CONTENT
data: {"type":"TEXT_MESSAGE_CONTENT","message_id":"msg-uuid","delta":"服务器"}

event: TEXT_MESSAGE_CONTENT
data: {"type":"TEXT_MESSAGE_CONTENT","message_id":"msg-uuid","delta":"当前状态"}

event: TEXT_MESSAGE_END
data: {"type":"TEXT_MESSAGE_END","message_id":"msg-uuid"}

event: RUN_FINISHED
data: {"type":"RUN_FINISHED","thread_id":"session-uuid","run_id":"run-uuid"}
```

---

## 3. 模块架构

### 3.1 后端模块划分

```
backend/
├── app/
│   ├── api/                      # API 路由层
│   │   ├── v1/                   # API v1 版本
│   │   │   ├── auth.py           # 认证相关路由
│   │   │   ├── users.py          # 用户管理路由
│   │   │   ├── sessions.py       # 会话管理路由
│   │   │   ├── models.py         # 模型管理路由
│   │   │   ├── mcp.py            # MCP 连接路由
│   │   │   ├── skills.py         # SKILL 管理路由
│   │   │   ├── knowledge.py      # 知识库路由
│   │   │   ├── rules.py          # 规则引擎路由
│   │   │   └── agent.py          # AG-UI Agent 端点
│   │
│   ├── core/                     # 核心配置
│   │   ├── config.py             # 应用配置
│   │   ├── security.py           # 安全相关
│   │   ├── deps.py               # 依赖注入
│   │   └── exceptions.py         # 异常定义
│   │
│   ├── models/                   # 数据模型
│   │   ├── user.py               # 用户模型
│   │   ├── session.py            # 会话模型
│   │   ├── message.py            # 消息模型
│   │   ├── llm_model.py          # LLM 模型配置
│   │   ├── mcp_connection.py     # MCP 连接配置
│   │   ├── skill.py              # SKILL 模型
│   │   ├── knowledge_base.py     # 知识库模型
│   │   └── rule.py               # 规则模型
│   │
│   ├── schemas/                  # Pydantic 模式
│   │   ├── user.py               # 用户模式
│   │   ├── session.py            # 会话模式
│   │   ├── message.py            # 消息模式
│   │   └── ...                   # 其他模式
│   │
│   ├── services/                 # 业务服务层
│   │   ├── user_service.py       # 用户服务
│   │   ├── session_service.py    # 会话服务
│   │   ├── model_service.py      # 模型管理服务
│   │   ├── mcp_service.py        # MCP 服务
│   │   ├── skill_service.py      # SKILL 服务
│   │   ├── rag_service.py        # RAG 服务
│   │   └── rule_service.py       # 规则引擎服务
│   │
│   ├── agents/                   # Agent 架构实现
│   │   ├── base.py               # Agent 基类
│   │   ├── react.py              # ReAct Agent
│   │   ├── agentic_rag.py        # AgenticRAG Agent
│   │   ├── plan_execute.py       # PlanAndExecute Agent
│   │   ├── reflexion.py          # Reflexion Agent
│   │   └── factory.py            # Agent 工厂
│   │
│   ├── integrations/             # 外部集成
│   │   ├── llm/                  # LLM 客户端
│   │   │   ├── base.py           # LLM 客户端基类
│   │   │   ├── openai.py         # OpenAI 客户端
│   │   │   └── anthropic.py      # Anthropic 客户端
│   │   ├── mcp/                  # MCP 客户端
│   │   │   ├── standard.py       # 标准 MCP 客户端
│   │   │   └── websocket.py      # WS-MCP 客户端
│   │   └── vector/               # 向量数据库
│   │       ├── base.py           # 向量存储基类
│   │       ├── milvus.py         # Milvus 客户端
│   │       └── qdrant.py         # Qdrant 客户端
│   │
│   ├── rules/                    # 规则引擎
│   │   ├── engine.py             # 规则引擎核心
│   │   ├── parser.py             # 规则解析器
│   │   ├── executor.py           # 规则执行器
│   │   └── conditions.py         # 条件处理
│   │
│   └── utils/                    # 工具函数
│       ├── logger.py             # 日志工具
│       ├── crypto.py             # 加密工具
│       └── validators.py         # 验证工具
│
├── tests/                        # 测试用例
├── alembic/                      # 数据库迁移
├── requirements.txt              # 依赖清单
├── main.py                       # 应用入口
└── Dockerfile                    # Docker 配置
```

### 3.2 前端模块划分

```
frontend/
├── src/
│   ├── api/                      # API 封装
│   │   ├── auth.ts               # 认证 API
│   │   ├── user.ts               # 用户 API
│   │   ├── session.ts            # 会话 API
│   │   ├── model.ts              # 模型 API
│   │   ├── mcp.ts                # MCP API
│   │   ├── skill.ts              # SKILL API
│   │   ├── knowledge.ts          # 知识库 API
│   │   ├── rule.ts               # 规则 API
│   │   └── request.ts            # Axios 封装
│   │
│   ├── assets/                   # 静态资源
│   │   ├── styles/               # 全局样式
│   │   └── images/               # 图片资源
│   │
│   ├── components/               # 公共组件
│   │   ├── common/               # 通用组件
│   │   │   ├── AppHeader.vue     # 头部组件
│   │   │   ├── AppSidebar.vue    # 侧边栏组件
│   │   │   └── ...
│   │   ├── chat/                 # 对话相关组件
│   │   │   ├── ChatMessage.vue   # 消息组件
│   │   │   ├── ChatInput.vue     # 输入组件
│   │   │   ├── ThinkingBlock.vue # 思考展示
│   │   │   ├── ToolCallBlock.vue # 工具调用展示
│   │   │   └── ...
│   │   ├── settings/             # 设置相关组件
│   │   └── rule/                 # 规则编辑器组件
│   │       ├── RuleEditor.vue    # 规则编辑器
│   │       ├── ConditionBuilder.vue # 条件构建器
│   │       └── ActionConfig.vue  # 动作配置器
│   │
│   ├── composables/              # 组合式函数
│   │   ├── useAuth.ts            # 认证逻辑
│   │   ├── useWebSocket.ts       # WebSocket 逻辑
│   │   ├── useChat.ts            # 对话逻辑
│   │   └── usePermission.ts      # 权限逻辑
│   │
│   ├── layouts/                  # 布局组件
│   │   ├── MainLayout.vue        # 主布局
│   │   └── SettingsLayout.vue    # 设置布局
│   │
│   ├── router/                   # 路由配置
│   │   ├── index.ts              # 路由入口
│   │   └── guards.ts             # 路由守卫
│   │
│   ├── stores/                   # 状态管理
│   │   ├── auth.ts               # 认证状态
│   │   ├── user.ts               # 用户状态
│   │   ├── session.ts            # 会话状态
│   │   ├── chat.ts               # 对话状态
│   │   └── settings.ts           # 设置状态
│   │
│   ├── types/                    # TypeScript 类型
│   │   ├── api.ts                # API 类型
│   │   ├── models.ts             # 数据模型类型
│   │   └── websocket.ts          # WebSocket 类型
│   │
│   ├── views/                    # 页面视图
│   │   ├── chat/                 # 对话页面
│   │   │   └── ChatView.vue      # 主对话页
│   │   ├── settings/             # 设置页面
│   │   │   ├── SettingsView.vue  # 设置主页
│   │   │   ├── ProfileView.vue   # 个人信息
│   │   │   ├── ModelsView.vue    # 模型管理
│   │   │   ├── MCPView.vue       # MCP 管理
│   │   │   ├── SkillsView.vue    # SKILL 管理
│   │   │   ├── KnowledgeView.vue # 知识库管理
│   │   │   ├── RulesView.vue     # 规则管理
│   │   │   ├── UsersView.vue     # 用户管理
│   │   │   └── SystemView.vue    # 系统设置
│   │   └── auth/                 # 认证页面
│   │       ├── LoginView.vue     # 登录页
│   │       └── RegisterView.vue  # 注册页
│   │
│   ├── App.vue                   # 根组件
│   ├── main.ts                   # 入口文件
│   └── env.d.ts                  # 环境变量类型
│
├── public/                       # 公共资源
├── package.json                  # NPM 配置
├── vite.config.ts                # Vite 配置
├── tsconfig.json                 # TS 配置
└── Dockerfile                    # Docker 配置
```

---

## 4. 数据流架构

### 4.1 Agent 对话数据流

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              Agent 对话数据流                                    │
└─────────────────────────────────────────────────────────────────────────────────┘

 ┌─────────┐                                                          ┌─────────┐
 │  用户    │                                                          │  LLM    │
 └────┬────┘                                                          └────┬────┘
      │                                                                    │
      │ 1. 发送消息                                                         │
      │ ─────────────────────────────────────────────────────────►         │
      │    (WebSocket: chat/send_message)                                  │
      │                                                                    │
      │                    ┌───────────────────────────────────┐           │
      │                    │         Agent Service             │           │
      │                    │                                   │           │
      │                    │  2. 解析配置                       │           │
      │                    │     ├─ 获取 Agent 架构             │           │
      │                    │     ├─ 获取模型配置                │           │
      │                    │     ├─ 获取可用工具                │           │
      │                    │     └─ 获取知识库配置              │           │
      │                    │                                   │           │
      │                    │  3. 创建 Agent 实例                │           │
      │                    │     └─ AgentFactory.create()      │           │
      │                    │                                   │           │
      │                    └───────────────────────────────────┘           │
      │                                     │                              │
      │                                     ▼                              │
      │                    ┌───────────────────────────────────┐           │
      │                    │           Agent 执行               │           │
      │                    │                                   │           │
      │ ◄──────────────────┤  4. 推送思考过程                    │           │
      │  (thinking)        │     └─ "分析用户意图..."           │           │
      │                    │                                   │           │
      │                    │  5. RAG 检索（如果启用）            │           │
      │                    │     └─ 检索相关文档                 ├─────────►│
      │                    │                                   │           │
      │ ◄──────────────────┤  6. 推送检索结果                    │           │
      │  (retrieval)       │                                   │           │
      │                    │                                   │           │
      │                    │  7. 调用 LLM 决策                  │◄──────────┤
      │                    │                                   │  响应     │
      │                    │                                   │           │
      │ ◄──────────────────┤  8. 推送工具调用（如果需要）        │           │
      │  (tool_call)       │     └─ 工具名、参数                │           │
      │                    │                                   │           │
      │                    │  9. 执行工具                       │           │
      │                    │     └─ MCP 客户端调用              │           │
      │                    │                                   │           │
      │ ◄──────────────────┤  10. 推送工具结果                   │           │
      │  (tool_result)     │                                   │           │
      │                    │                                   │           │
      │                    │  11. 继续 LLM 对话                 ├─────────►│
      │                    │      （工具结果作为上下文）          │           │
      │                    │                                   │◄──────────┤
      │                    │                                   │           │
      │ ◄──────────────────┤  12. 推送最终回复                   │           │
      │  (assistant)       │      （流式返回）                   │           │
      │                    │                                   │           │
      │                    │  13. 保存会话历史                   │           │
      │                    │                                   │           │
      │                    └───────────────────────────────────┘           │
      │                                                                    │
      ▼                                                                    ▼
```

### 4.2 规则引擎数据流

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              规则引擎数据流                                      │
└─────────────────────────────────────────────────────────────────────────────────┘

 ┌─────────────┐                                              ┌─────────────┐
 │ WS-MCP      │                                              │  执行目标   │
 │ Server      │                                              │  (MCP/SKILL)│
 └──────┬──────┘                                              └──────┬──────┘
        │                                                            │
        │ 1. 推送事件                                                 │
        │ ──────────────────────────────────────────►                │
        │    { type: "event", event: "player_join", data: {...} }    │
        │                                                            │
        │            ┌─────────────────────────────────────┐         │
        │            │          WS-MCP Client              │         │
        │            │                                     │         │
        │            │  2. 接收事件                         │         │
        │            │     └─ 解析事件数据                  │         │
        │            │                                     │         │
        │            └──────────────┬──────────────────────┘         │
        │                           │                                │
        │                           ▼                                │
        │            ┌─────────────────────────────────────┐         │
        │            │          Rule Engine                │         │
        │            │                                     │         │
        │            │  3. 匹配规则                         │         │
        │            │     ├─ 查找事件对应的规则            │         │
        │            │     └─ 过滤已启用的规则              │         │
        │            │                                     │         │
        │            │  4. 评估条件                         │         │
        │            │     ├─ 解析条件表达式                │         │
        │            │     └─ 判断是否满足                  │         │
        │            │                                     │         │
        │            │  5. 检查冷却                         │         │
        │            │     └─ 判断是否在冷却期内            │         │
        │            │                                     │         │
        │            └──────────────┬──────────────────────┘         │
        │                           │                                │
        │                           ▼ (条件满足)                      │
        │            ┌─────────────────────────────────────┐         │
        │            │         Action Executor             │         │
        │            │                                     │         │
        │            │  6. 执行动作                         │         │
        │            │     ├─ 变量替换（模板渲染）           │         │
        │            │     ├─ 调用 MCP 工具                 ├────────►│
        │            │     ├─ 执行 SKILL                   │         │
        │            │     └─ 发送通知                      │         │
        │            │                                     │◄────────┤
        │            │  7. 记录执行日志                     │  结果    │
        │            │                                     │         │
        │            │  8. 更新冷却时间                     │         │
        │            │                                     │         │
        │            └─────────────────────────────────────┘         │
        │                                                            │
        ▼                                                            ▼
```

---

## 5. 安全架构

### 5.1 认证与授权

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              认证授权架构                                        │
└─────────────────────────────────────────────────────────────────────────────────┘

        ┌─────────────────────────────────────────────────────────────────┐
        │                         认证层                                   │
        │                                                                  │
        │   ┌─────────────┐     ┌─────────────┐     ┌─────────────┐      │
        │   │   登录      │     │  JWT Token  │     │  Token      │      │
        │   │   认证      │────►│   生成      │────►│   验证      │      │
        │   │             │     │             │     │             │      │
        │   └─────────────┘     └─────────────┘     └─────────────┘      │
        │                                                  │              │
        └──────────────────────────────────────────────────┼──────────────┘
                                                           │
                                                           ▼
        ┌─────────────────────────────────────────────────────────────────┐
        │                         授权层                                   │
        │                                                                  │
        │   ┌─────────────┐     ┌─────────────┐     ┌─────────────┐      │
        │   │   获取      │     │   检查      │     │   权限      │      │
        │   │   用户角色  │────►│   权限      │────►│   决策      │      │
        │   │             │     │             │     │             │      │
        │   └─────────────┘     └─────────────┘     └─────────────┘      │
        │                                                                  │
        └─────────────────────────────────────────────────────────────────┘

JWT Token 结构:
{
  "sub": "user-uuid",          // 用户 ID
  "username": "username",      // 用户名
  "role": "developer",         // 用户角色
  "permissions": [...],        // 权限列表
  "exp": 1234567890,           // 过期时间
  "iat": 1234567890            // 签发时间
}
```

### 5.2 数据安全

| 数据类型 | 安全措施 |
|---------|---------|
| 用户密码 | bcrypt 哈希存储 |
| API 密钥 | AES-256 加密存储 |
| JWT Token | RS256 签名 |
| 通信数据 | HTTPS/WSS 传输加密 |
| 敏感日志 | 脱敏处理 |

### 5.3 访问控制

| 资源 | 访问控制 |
|------|---------|
| 会话 | 用户只能访问自己的会话 |
| SKILL | 支持公共/私有，私有 SKILL 仅创建者可访问 |
| 知识库 | 支持公共/私有，私有知识库仅创建者可访问 |
| 规则 | 用户只能管理自己的规则 |
| 模型配置 | 管理员配置，用户只能使用被授权的模型 |
| MCP 连接 | 管理员配置，用户只能使用被授权的连接 |

---

## 6. 部署架构

### 6.1 开发环境

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           开发环境部署架构                                       │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                         Docker Compose                                   │   │
│   │                                                                          │   │
│   │   ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐              │   │
│   │   │PostgreSQL│  │  Redis   │  │  Milvus  │  │  MinIO   │              │   │
│   │   │  :5432   │  │  :6379   │  │  :19530  │  │  :9000   │              │   │
│   │   └──────────┘  └──────────┘  └──────────┘  └──────────┘              │   │
│   │                                                                          │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│   ┌──────────────────────────────┐  ┌──────────────────────────────┐          │
│   │       Backend (本地)         │  │       Frontend (本地)         │          │
│   │                              │  │                              │          │
│   │   uvicorn main:app          │  │   npm run dev                │          │
│   │   --reload                   │  │                              │          │
│   │   --port 8000                │  │   :5173                      │          │
│   │                              │  │                              │          │
│   └──────────────────────────────┘  └──────────────────────────────┘          │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 6.2 生产环境

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           生产环境部署架构                                       │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│                              ┌──────────────┐                                   │
│                              │    Nginx     │                                   │
│                              │  (负载均衡)   │                                   │
│                              └──────┬───────┘                                   │
│                                     │                                           │
│                    ┌────────────────┼────────────────┐                         │
│                    │                │                │                         │
│                    ▼                ▼                ▼                         │
│   ┌──────────────────────────────────────────────────────────────────────┐    │
│   │                         应用服务集群                                   │    │
│   │                                                                        │    │
│   │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────────────────┐  │    │
│   │  │ Backend  │  │ Backend  │  │ Backend  │  │   Frontend (静态)     │  │    │
│   │  │   :8000  │  │   :8001  │  │   :8002  │  │   Nginx 托管          │  │    │
│   │  └──────────┘  └──────────┘  └──────────┘  └──────────────────────┘  │    │
│   │                                                                        │    │
│   └──────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
│   ┌──────────────────────────────────────────────────────────────────────┐    │
│   │                         数据服务集群                                   │    │
│   │                                                                        │    │
│   │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                │    │
│   │  │  PostgreSQL  │  │    Redis     │  │   Milvus     │                │    │
│   │  │  (主从复制)   │  │  (Cluster)   │  │  (Cluster)   │                │    │
│   │  └──────────────┘  └──────────────┘  └──────────────┘                │    │
│   │                                                                        │    │
│   └──────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
│   ┌──────────────────────────────────────────────────────────────────────┐    │
│   │                         任务处理集群                                   │    │
│   │                                                                        │    │
│   │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                │    │
│   │  │   Celery     │  │   Celery     │  │   Celery     │                │    │
│   │  │   Worker 1   │  │   Worker 2   │  │   Worker 3   │                │    │
│   │  └──────────────┘  └──────────────┘  └──────────────┘                │    │
│   │                                                                        │    │
│   └──────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. 扩展性设计

### 7.1 Agent 架构扩展

Agent 架构采用工厂模式和策略模式，便于扩展新的 Agent 类型：

```
BaseAgent (抽象基类)
    │
    ├── run()                    # 执行入口（模板方法）
    ├── think()                  # 思考过程（抽象方法）
    ├── act()                    # 执行动作（抽象方法）
    ├── reflect()                # 反思过程（可选）
    └── get_context()            # 获取上下文
    
    ▼ 继承
    
ReActAgent                       # ReAct 实现
AgenticRAGAgent                  # AgenticRAG 实现
PlanAndExecuteAgent              # 计划执行实现
ReflexionAgent                   # 反思改进实现
CustomAgent                      # 自定义扩展

AgentFactory
    │
    └── create(agent_type, config) → BaseAgent
```

**扩展步骤：**
1. 创建新的 Agent 类，继承 `BaseAgent`
2. 实现 `think()` 和 `act()` 方法
3. 在 `AgentFactory` 中注册新类型
4. 在前端添加新架构选项

### 7.2 LLM 客户端扩展

```
BaseLLMClient (抽象基类)
    │
    ├── chat()                   # 对话接口
    ├── chat_stream()            # 流式对话
    └── get_embeddings()         # 向量化（可选）
    
    ▼ 继承
    
OpenAIClient                     # OpenAI 协议
AnthropicClient                  # Anthropic 协议
CustomClient                     # 自定义扩展
```

### 7.3 MCP 客户端扩展

```
BaseMCPClient (抽象基类)
    │
    ├── connect()                # 建立连接
    ├── disconnect()             # 断开连接
    ├── list_tools()             # 获取工具列表
    ├── call_tool()              # 调用工具
    └── on_event()               # 事件处理（可选）
    
    ▼ 继承
    
StandardMCPClient                # 标准 HTTP SSE
WebSocketMCPClient               # WebSocket 协议
```

### 7.4 向量存储扩展

```
BaseVectorStore (抽象基类)
    │
    ├── create_collection()      # 创建集合
    ├── insert()                 # 插入向量
    ├── search()                 # 相似搜索
    └── delete()                 # 删除向量
    
    ▼ 继承
    
MilvusStore                      # Milvus 实现
QdrantStore                      # Qdrant 实现
```

---

## 8. 附录

### 8.1 相关文档

- [产品需求文档](./ProductRequirements.md)
- [后端模块设计](./BackendDesign.md)
- [前端界面设计](./FrontendDesign.md)
- [数据库设计](./DatabaseDesign.md)
- [API 接口设计](./APIDesign.md)
- [开发计划](./DevelopmentPlan.md)
- [WS-MCP 协议规范](./CustomizeWsMessageProcotol.md)
